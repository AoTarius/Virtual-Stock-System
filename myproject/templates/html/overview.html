{% load static %}  <!-- 加载模板标签库 -->
<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Invest — 导航栏示例</title>
	<style>
		:root{
			--nav-height:64px;
			--nav-bg:#2f6fe8; /* 主蓝色 */
			--nav-bg-dark:#2a63d1;
			--container-width:1180px;
			--text-light: #ffffff;
			--muted: rgba(255,255,255,0.85);
            --sep-color: #d0cfcf;
		}
		html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
		/* 顶部导航 */
		.topbar{
			height:var(--nav-height);
			background: linear-gradient(180deg,var(--nav-bg),var(--nav-bg-dark));
			color:var(--text-light);
			display:flex;
			align-items:center;
			box-shadow: 0 1px 0 rgba(0,0,0,0.08);
		}
        .topbar .wrap{
            width:100%;
            max-width:var(--container-width);
            margin:0 auto;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 16px;
            box-sizing:border-box;
        }
        /* 左侧容器：包含 logo 和 主导航，整体靠左 */
		.left{
			display:flex;
			align-items:center;
			gap:12px;
			flex:1; /* 占据主区域，推动右侧 actions 靠右 */
		}
		/* 左侧 logo */
		.logo{
			display:flex;
            align-items:center;
            gap:12px;
            color:var(--text-light);
            text-decoration:none;
            font-weight:600;
            font-size:18px;
		}
		.logo .mark{
			width:36px;
			height:36px;
			border-radius:6px;
			display:block;
			object-fit:cover;
			overflow:hidden;
		}
		/* 中间导航 */
        .nav{
            display:flex;
            align-items:center;
            gap:20px;
            margin-left:12px;
            justify-content:flex-start;
        }
		.nav a{
            color:var(--muted);
            text-decoration:none;
            padding:10px 8px;
            border-radius:4px;
            font-size:15px
        }
		.nav a:hover{
            color:var(--text-light);
            background:rgba(255,255,255,0.06)
        }
		.nav .active{
            color:var(--text-light);
            background:rgba(255,255,255,0.08)
        }
		/* 右侧操作区 */
		.actions{
            display:flex;
            align-items:center;
            gap:12px
        }
		.btn{
			background:transparent;
            border:1px solid rgba(255,255,255,0.12);
            color:var(--text-light);
            padding:8px 12px;
            border-radius:6px;
            font-size:14px;
            text-decoration:none;
            display:inline-flex;
            align-items:center;
            gap:8px;
		}
		.btn.primary{
            background: #ff7a00;
            border-color: #ff7a00;
            color:#fff
        }
		.user{
			display:flex;
            align-items:center;
            gap:8px;
            color:var(--text-light);
            padding:6px 8px;
            border-radius:6px;
            font-size:14px;
            text-decoration:none
		}
		.user .avatar{
            width:32px;
            height:32px;
            border-radius:50%;
            background:rgba(255,255,255,0.18);
            display:inline-block;
        }
		/* 响应 */
		@media (max-width:1000px){
			.nav{display:none}
		}
		@media (max-width:420px){
			.wrap{padding:0 8px}
			.logo span{display:none}
		}

		/* 页面主内容 */
		.main-content{
			padding:40px;
			font-size:14px;
			color:#333;
		}

		/* 与 invest.html 中相同的日期选择器样式（用于欢迎语旁的日期选择） */
		.date-wrapper{ display:flex; gap:8px; align-items:center; position:relative }
		.date-wrapper #selected-date{ flex:1 }
		/* 将原生日历输入透明覆盖在右侧按钮处以触发系统选择器（不改变可见样式） */
		.hidden-date{
			position:absolute;
			right:0;
			top:0;
			width:44px; /* 覆盖按钮区域 */
			height:100%;
			opacity:0; /* 看不见但可点击 */
			border:0; background:transparent; cursor:pointer; z-index:3;
		}
		#selected-date::placeholder{ color:#bfbfbf }

		/* 三数字行：三段数字，中间用短竖线分隔，并平铺整行 */
		.stats-row{
			display:flex;
			align-items:center;
			width:100%;
		}
		.num-block{
			flex:1;
			text-align:center;
			font-size:28px;
			font-weight:700;
			color:#222;
			padding:18px 8px;
			display:flex;
			flex-direction:column;
			align-items:center;
			gap:6px;
		}
		.num-block .num-title{
			font-size:13px;
			color:#666;
			font-weight:500;
		}
		.num-block .num-value{
			font-size:28px;
			font-weight:700;
			color:#222;
		}
		.sep{
			width:2px;
			height:5vh; /* 短竖线 */
			background:var(--sep-color);
		}
        .sep-line{
            width:100%;
            height:2px;
            background:var(--sep-color);
            margin:24px 0;
        }

		/* 股票卡片样式（非表格） */
		.stock-card{
			display:flex;
			justify-content:space-between;
			align-items:center;
			background:#fff;
			border:1px solid #eee;
			box-shadow:0 2px 6px rgba(0,0,0,0.03);
			border-radius:8px;
			padding:18px 20px;
			gap:20px;
			margin-top:12px;
		}
		.stock-left{
			display:flex;
			flex-direction:column;
			gap:8px;
		}
		.stock-title{
			font-size:20px;
			font-weight:700;
			color:#111;
		}
		.stock-meta{
			font-size:14px;
			color:#666;
			display:flex;
			gap:14px;
			align-items:center
		}
		.stock-code{
			color:#999
		}
		.stock-price strong{
			color:#222;
			font-weight:700
		}

		.stock-right{
			display:flex;
			gap:18px;
			align-items:center
		}
		.metric{display:flex;
			flex-direction:column;
			align-items:center;
			min-width:120px
		}
		.metric-title{
			font-size:12px;
			color:#888;
			margin-bottom:6px
		}
		.metric-value{
			font-size:18px;
			font-weight:700;
			color:#222
		}
		.metric-value.positive{
			color:#16a34a
		}
		.metric-value.negative{
			color:#ef4444
		}

		@media (max-width:700px){
			.stock-card{
				flex-direction:column;
				align-items:flex-start
			}
			.stock-right{
				width:100%;
				display:flex;
				justify-content:space-between
			}
			.metric{
				min-width:unset
			}
		}
	</style>
</head>
<body>
	<header class="topbar" role="banner">
		<div class="wrap">
			<div class="left">
				<a class="logo" href="#">
					<img class="mark" src="{% static 'sources/pic/logo.png' %}" alt="logo">
					<span>花梨投资小课堂</span>
				</a>
				<nav class="nav" role="navigation" aria-label="主导航">
					<a class="active" href="#">投资概览</a>
					<a href="{% url 'myapp:invest' %}">订阅股票</a>
					<a href="{% url 'myapp:record' %}">买卖记录</a>
					<a href="#">金融分析</a>
					<a href="#">金融编程</a>
					<a href="#">更多</a>
				</nav>
			</div>
			<div class="actions">
				<a class="user" href="#">
					<span class="avatar" aria-hidden="true"></span>
					<span>{{ username|default:"游客" }}</span>
				</a>
			</div>
		</div>
	</header>

	<!-- 页面其余占位内容，仅用于视觉对比 -->
	<main class="main-content">
		<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
			<h2 style="margin:0">欢迎您，{{ username|default:"游客" }}！</h2>
			<!-- 与 invest.html 中一致的日期选择器（只读显示 + 隐藏的原生 date 输入） -->
			<div class="date-wrapper" style="min-width:220px; max-width:320px;">
				<input id="selected-date" type="text" placeholder="yyyy/mm/dd" readonly />
				<input id="date-picker" type="date" aria-label="选择日期" class="hidden-date" />
			</div>
		</div>
		<!-- 三数字行：三个等宽数字，中间用灰色短竖线分隔，整行平铺 -->
		<div class="stats-row" aria-label="关键数字" id="overview-stats-row">
			<div class="num-block">
				<div class="num-title">总投入</div>
				<div class="num-value"><span id="total_input_val">-</span></div>
			</div>
			<div class="sep" aria-hidden="true"></div>
			<div class="num-block">
				<div class="num-title">总盈亏</div>
				<div class="num-value"><span id="total_profit_val">-</span></div>
			</div>
			<div class="sep" aria-hidden="true"></div>
			<div class="num-block">
				<div class="num-title">总市价</div>
				<div class="num-value"><span id="total_market_val">-</span></div>
			</div>
		</div>
		<div class="sep-line" aria-hidden="true"></div>
		<!-- 若用户在所选日期没有任何持仓，则展示该提示 -->
		<div id="no-stocks-msg" style="display:none;color:#c0392b;text-align:center;margin-bottom:12px;">您还未持有任何股票</div>
		<!-- 持仓列表容器：由 JS 动态渲染持仓卡片 -->
		<div id="holdings-list"></div>
	</main>
</main>

	<script>
	(function setupOverviewDatePicker(){
		const selectedDateEl = document.getElementById('selected-date');
		const datePickerEl = document.getElementById('date-picker');
		if(!datePickerEl || !selectedDateEl) return;
		// 设置最大为今天
		try{
			const d = new Date();
			const y = d.getFullYear();
			const m = String(d.getMonth()+1).padStart(2,'0');
			const day = String(d.getDate()).padStart(2,'0');
			const iso = `${y}-${m}-${day}`;
			datePickerEl.max = iso;
		}catch(e){ /* ignore */ }

		function fmt(isoDate){
			if(!isoDate) return '';
			const dt = new Date(isoDate);
			if(isNaN(dt)) return isoDate;
			const Y = dt.getFullYear();
			const M = String(dt.getMonth()+1).padStart(2,'0');
			const D = String(dt.getDate()).padStart(2,'0');
			return `${Y}/${M}/${D}`;
		}

		datePickerEl.addEventListener('change', function(){
			// 验证：不能选择周末（与 invest.html 一致）
			if(this.value){
				const sel = new Date(this.value);
				const wd = sel.getDay();
				if(wd === 0 || wd === 6){
					// 提示并清空
					// 这里不展示全局提示，直接恢复为空并 alert 提示用户
					alert('所选日期为周末，请选择工作日');
					this.value = '';
					selectedDateEl.value = '';
					return;
				}
			}
			selectedDateEl.value = this.value ? fmt(this.value) : '';
			// 选择日期后请求后端更新用户持仓统计
			try{
				const iso = this.value; // YYYY-MM-DD
				if(iso){
					const y = iso.slice(0,4);
					const m = iso.slice(5,7);
					const d = iso.slice(8,10);
					const dateParam = `${y}${m}${d}`; // YYYYMMDD
					fetchTotalValue(dateParam);
				}
			}catch(e){ console.warn('fetchTotalValue trigger failed', e); }
		});

		function openPicker(){
			try{ if(typeof datePickerEl.showPicker === 'function') datePickerEl.showPicker(); else { datePickerEl.click(); datePickerEl.focus(); } }
			catch(e){ try{ datePickerEl.click(); datePickerEl.focus(); }catch(_){}}
		}

		selectedDateEl.addEventListener('click', openPicker);

		// helper: format number to localized currency-like string
		function fmtNumber(n){
			if(n === null || n === undefined) return '-';
			const num = Number(n);
			if(isNaN(num)) return '-';
			return num.toLocaleString('zh-CN', {minimumFractionDigits:2, maximumFractionDigits:2});
		}

		const currentUserId = "{{ user_id|default:'' }}";
		const userTotalUrl = "{% url 'myapp:user_total_value' %}";

		async function fetchTotalValue(dateYYYYMMDD){
			try{
				let url = `${userTotalUrl}?date=${encodeURIComponent(dateYYYYMMDD)}`;
				if(currentUserId) url += `&user_id=${encodeURIComponent(currentUserId)}`;
				const res = await fetch(url);
				if(!res.ok){ console.warn('user_total_value API returned', res.status); return; }
				const j = await res.json();
				const statsRow = document.getElementById('overview-stats-row');
				const noMsg = document.getElementById('no-stocks-msg');
				const inEl = document.getElementById('total_input_val');
				const profitEl = document.getElementById('total_profit_val');
				const marketEl = document.getElementById('total_market_val');
				if(!j){ console.warn('user_total_value empty json'); return; }
				if(j.found === false){
					// show message under sep-line
					if(statsRow) statsRow.style.display = 'none';
					if(noMsg) noMsg.style.display = 'block';
					return;
				}
				// found true
				if(statsRow) statsRow.style.display = '';
				if(noMsg) noMsg.style.display = 'none';
				const total_input = j.total_input;
				const total_stock_value = j.total_stock_value;
				const total_profit = (Number(total_stock_value) - Number(total_input));
				if(inEl) inEl.textContent = fmtNumber(total_input);
				if(profitEl){
					profitEl.textContent = fmtNumber(total_profit);
					profitEl.classList.remove('positive','negative');
					if(total_profit>0) profitEl.classList.add('positive');
					else if(total_profit<0) profitEl.classList.add('negative');
				}
				if(marketEl) marketEl.textContent = fmtNumber(total_stock_value);
				// 渲染持仓列表（若有）
				const holdingsList = document.getElementById('holdings-list');
				function renderHoldings(hlist){
					if(!holdingsList) return;
					holdingsList.innerHTML = '';
					if(!hlist || !Array.isArray(hlist) || hlist.length === 0) return;
					for(const h of hlist){
						const card = document.createElement('section');
						card.className = 'stock-card';
						card.setAttribute('aria-label','股票展示');
						const left = document.createElement('div'); left.className='stock-left';
						const title = document.createElement('div'); title.className='stock-title';
						title.textContent = h.name || '—';
						const meta = document.createElement('div'); meta.className='stock-meta';
						const codeSpan = document.createElement('span'); codeSpan.className='stock-code';
						codeSpan.textContent = h.stockID || '';
						const priceSpan = document.createElement('span'); priceSpan.className='stock-price';
						const priceStrong = document.createElement('strong');
						priceStrong.textContent = (h.close !== null && h.close !== undefined) ? ('¥' + fmtNumber(h.close)) : '—';
						priceSpan.innerHTML = '今日股价&nbsp;'; priceSpan.appendChild(priceStrong);
						meta.appendChild(codeSpan); meta.appendChild(priceSpan);
						left.appendChild(title); left.appendChild(meta);
						const right = document.createElement('div'); right.className='stock-right';
						// piles
						const m1 = document.createElement('div'); m1.className='metric';
						m1.innerHTML = `<div class="metric-title">已购入股数</div><div class="metric-value">${h.piles ?? '-'}</div>`;
						// cost
						const m2 = document.createElement('div'); m2.className='metric';
						m2.innerHTML = `<div class="metric-title">已投资金额</div><div class="metric-value">¥${fmtNumber(h.cost)}</div>`;
						// profit
						const m3 = document.createElement('div'); m3.className='metric';
						const profitVal = (h.profit !== null && h.profit !== undefined) ? Number(h.profit) : null;
						const profitClass = profitVal>0 ? 'metric-value positive' : (profitVal<0 ? 'metric-value negative' : 'metric-value');
						const profitText = profitVal===null ? '-' : `¥${fmtNumber(profitVal>0? ('+'+profitVal): profitVal)}`;
						m3.innerHTML = `<div class="metric-title">当前营收</div><div class="${profitClass}">${profitText}</div>`;
						right.appendChild(m1); right.appendChild(m2); right.appendChild(m3);
						card.appendChild(left); card.appendChild(right);
						holdingsList.appendChild(card);
					}
				}
				if(j.holdings) renderHoldings(j.holdings);
			}catch(e){ console.warn('fetchTotalValue failed', e); }
		}

	})();
	</script>
</body>
</html>

