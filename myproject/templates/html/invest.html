<!--
# åœ¨é¡¹ç›®æ ¹ï¼ˆd:\VSCode_Data\Project\finance_systemï¼‰è¿è¡Œä¸€æ¬¡ï¼ˆå¦‚æœæœ‰ Pythonï¼‰ï¼š
python -m http.server 8000
# ç„¶ååœ¨æµè§ˆå™¨æ‰“å¼€ï¼š
http://localhost:8000/html/invest.html
-->

{% load static %}  <!-- åŠ è½½æ¨¡æ¿æ ‡ç­¾åº“ -->
<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Invest â€” å¯¼èˆªæ ç¤ºä¾‹</title>
	<style>
		:root{
			--nav-height:64px;
			--nav-bg:#2f6fe8; /* ä¸»è“è‰² */
			--nav-bg-dark:#2a63d1;
			--container-width:1180px;
			--text-light: #ffffff;
			--muted: rgba(255,255,255,0.85);
            --sep-color: #d0cfcf;
		}
		html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
		/* é¡¶éƒ¨å¯¼èˆª */
		.topbar{
			height:var(--nav-height);
			background: linear-gradient(180deg,var(--nav-bg),var(--nav-bg-dark));
			color:var(--text-light);
			display:flex;
			align-items:center;
			box-shadow: 0 1px 0 rgba(0,0,0,0.08);
		}
        .topbar .wrap{
            width:100%;
            max-width:var(--container-width);
            margin:0 auto;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 16px;
            box-sizing:border-box;
        }
        /* å·¦ä¾§å®¹å™¨ï¼šåŒ…å« logo å’Œ ä¸»å¯¼èˆªï¼Œæ•´ä½“é å·¦ */
		.left{
			display:flex;
			align-items:center;
			gap:12px;
			flex:1; /* å æ®ä¸»åŒºåŸŸï¼Œæ¨åŠ¨å³ä¾§ actions é å³ */
		}
		/* å·¦ä¾§ logo */
		.logo{
			display:flex;
            align-items:center;
            gap:12px;
            color:var(--text-light);
            text-decoration:none;
            font-weight:600;
            font-size:18px;
		}
		.logo .mark{
			width:36px;
			height:36px;
			border-radius:6px;
			display:block;
			object-fit:cover;
			overflow:hidden;
		}
		/* ä¸­é—´å¯¼èˆª */
        .nav{
            display:flex;
            align-items:center;
            gap:20px;
            margin-left:12px;
            justify-content:flex-start;
        }
		.nav a{
            color:var(--muted);
            text-decoration:none;
            padding:10px 8px;
            border-radius:4px;
            font-size:15px
        }
		.nav a:hover{
            color:var(--text-light);
            background:rgba(255,255,255,0.06)
        }
		.nav .active{
            color:var(--text-light);
            background:rgba(255,255,255,0.08)
        }
		/* å³ä¾§æ“ä½œåŒº */
		.actions{
            display:flex;
            align-items:center;
            gap:12px
        }
		.btn{
			background:transparent;
            border:1px solid rgba(255,255,255,0.12);
            color:var(--text-light);
            padding:8px 12px;
            border-radius:6px;
            font-size:14px;
            text-decoration:none;
            display:inline-flex;
            align-items:center;
            gap:8px;
		}
		.btn.primary{
            background: #ff7a00;
            border-color: #ff7a00;
            color:#fff
        }
		.user{
			display:flex;
            align-items:center;
            gap:8px;
            color:var(--text-light);
            padding:6px 8px;
            border-radius:6px;
            font-size:14px;
            text-decoration:none
		}
		.user .avatar{
            width:32px;
            height:32px;
            border-radius:50%;
            background:rgba(255,255,255,0.18);
            display:inline-block;
        }
		/* å“åº” */
		@media (max-width:1000px){
			.nav{display:none}
		}
		@media (max-width:420px){
			.wrap{padding:0 8px}
			.logo span{display:none}
		}

		/* é¡µé¢ä¸»å†…å®¹ */
		.main-content{
			padding:40px;
			font-size:14px;
			color:#333;
		}

		/* ä¸‰æ•°å­—è¡Œï¼šä¸‰æ®µæ•°å­—ï¼Œä¸­é—´ç”¨çŸ­ç«–çº¿åˆ†éš”ï¼Œå¹¶å¹³é“ºæ•´è¡Œ */
		.stats-row{
			display:flex;
			align-items:center;
			width:100%;
		}
		.num-block{
			flex:1;
			text-align:center;
			font-size:28px;
			font-weight:700;
			color:#222;
			padding:18px 8px;
			display:flex;
			flex-direction:column;
			align-items:center;
			gap:6px;
		}
		.num-block .num-title{
			font-size:13px;
			color:#666;
			font-weight:500;
		}
		.num-block .num-value{
			font-size:28px;
			font-weight:700;
			color:#222;
		}
		.sep{
			width:2px;
			height:5vh; /* çŸ­ç«–çº¿ */
			background:var(--sep-color);
		}
        .sep-line{
            width:100%;
            height:2px;
            background:var(--sep-color);
            margin:24px 0;
        }

		/* è‚¡ç¥¨æŸ¥è¯¢åŒºæ ·å¼ï¼ˆå·²å°†åŸå†…è”æ ·å¼ç§»è‡³æ­¤å¤„ï¼‰ */
		#stock-search{ max-width:880px; margin:0 auto; }
		#stock-search .controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
		#stock-search label{ flex:1; min-width:220px; display:block; }
		#stock-search .field-title{ font-size:13px; color:#666; margin-bottom:6px; display:block; }
		#stock-search input[type="text"],
		#stock-search input[type="number"],
		#selected-date{ width:80%; padding:10px; border:1px solid var(--sep-color); border-radius:6px; font-size:14px; box-sizing:border-box; }
		/* éšè—çš„åŸç”Ÿæ—¥æœŸæ§ä»¶ï¼šé€æ˜è¦†ç›–åœ¨å±•ç¤ºè¾“å…¥ä¸Šä»¥å®ç°å•æ¡†äº¤äº’ */

		.date-wrapper{ display:flex; gap:8px; align-items:center; position:relative }
		.date-wrapper #selected-date{ flex:1 }
		/* å°†åŸç”Ÿæ—¥å†è¾“å…¥é€æ˜è¦†ç›–åœ¨å³ä¾§æŒ‰é’®å¤„ä»¥è§¦å‘ç³»ç»Ÿé€‰æ‹©å™¨ï¼ˆä¸æ”¹å˜å¯è§æ ·å¼ï¼‰ */
		.hidden-date{
			position:absolute;
			right:0;
			top:0;
			width:44px; /* è¦†ç›–æŒ‰é’®åŒºåŸŸ */
			height:100%;
			opacity:0; /* çœ‹ä¸è§ä½†å¯ç‚¹å‡» */
			border:0; background:transparent; cursor:pointer; z-index:3;
		}
		#selected-date::placeholder{ color:#bfbfbf }
		#stock-search button#btn-clear{ height:44px; }
		#stock-search #search-note{ margin-top:10px; color:#666; font-size:13px; }
		#stock-search #not-found{ margin-top:8px; color:#c0392b; font-size:13px; display:none }
		#stock-search #stock-info{ margin-top:20px; padding:16px; border:1px dashed #e6e6e6; border-radius:8px; display:none }
        #stock-search .info-row{ display:flex; gap:18px; align-items:center; flex-wrap:wrap }
        #stock-search .info-col{ min-width:180px }
        #stock-search .info-chart-col{ flex:1; min-width:260px }
        #stock-search .info-col .field-title,
        #stock-search .info-chart-col .field-title{ font-size:12px; color:#888 }
        #stock-search #today-price{ font-size:22px; font-weight:700; margin-top:6px }
        #stock-search #price-diff{ font-size:18px; margin-top:6px; color:#333 }
        #stock-search #chart-area{ height: 240px;background: #fff;border-radius: 8px;padding: 8px;box-sizing: border-box; }
        #stock-search #stock-meta{ margin-top:12px; color:#666; font-size:13px }

		/* è´­å…¥æ§ä»¶æ ·å¼ï¼ˆåˆå§‹éšè—ï¼Œæ‰¾åˆ°è‚¡ç¥¨æ—¶æ˜¾ç¤ºï¼‰ */
		#buy-controls{
			margin-top:14px;
			display:none;
			width:100%;
			align-items:center;
			gap:12px;
			justify-content:space-between;
			flex-wrap:nowrap;
		}
		/* å·¦ä¾§ä¿æŒä¸€è¡Œï¼Œä¸æ¢è¡Œ */
		#buy-controls .buy-left{
			display:flex;
			align-items:center;
			gap:8px;
			flex:1 1 auto;
			min-width:0;
			flex-wrap:nowrap;
			white-space:nowrap;
		}
		/* å›ºå®šè¾ƒå°å®½åº¦ï¼Œé¿å…æ¢è¡Œ */
		#buy-count{ padding:8px 10px; border:1px solid #ddd; border-radius:6px; width:90px; font-size:14px; box-sizing:border-box; flex:0 0 auto }
		#buy-amount{ padding:8px 10px; border:1px solid #ddd; border-radius:6px; width:120px; font-size:14px; box-sizing:border-box; background:#f7f7f7; flex:0 0 auto }
		#buy-controls .buy-actions{ display:flex; flex-direction:column; gap:8px; align-items:flex-end }
		#btn-buy{ background:#2f6fe8; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer }
		#btn-buy-cancel{ background:#f3f3f3; color:#333; border:1px solid #ddd; padding:8px 14px; border-radius:6px; cursor:pointer }
	</style>
	<script src="{% static 'js/dayjs.min.js' %}"></script>
	<script src="{% static 'js/chart.umd.min.js' %}"></script>
</head>
<body>
	<header class="topbar" role="banner">
		<div class="wrap">
			<div class="left">
				<a class="logo" href="#">
					<img class="mark" src="{% static 'sources/pic/logo.png' %}" alt="logo">
					<span>èŠ±æ¢¨æŠ•èµ„å°è¯¾å ‚</span>
				</a>
				<nav class="nav" role="navigation" aria-label="ä¸»å¯¼èˆª">
					<a href="{% url 'myapp:overview' %}">æŠ•èµ„æ¦‚è§ˆ</a>
					<a class="active" href="#">è®¢é˜…è‚¡ç¥¨</a>
					<a href="{% url 'myapp:record' %}">ä¹°å–è®°å½•</a>
					<a href="#">é‡‘èåˆ†æ</a>
					<a href="#">é‡‘èç¼–ç¨‹</a>
					<a href="#">æ›´å¤š</a>
				</nav>
			</div>
			<div class="actions">
				<a class="user" href="#">
					<span class="avatar" aria-hidden="true"></span>
					<span>{{ username|default:"æ¸¸å®¢" }}</span>
				</a>
			</div>
		</div>
	</header>

	<!-- é¡µé¢å…¶ä½™å ä½å†…å®¹ï¼Œä»…ç”¨äºè§†è§‰å¯¹æ¯” -->
	<main class="main-content">
		<h2>æ¬¢è¿æ‚¨ï¼Œ{{ username|default:"æ¸¸å®¢" }}ï¼</h2>
		<!-- ä¸‰æ•°å­—è¡Œï¼šä¸‰ä¸ªç­‰å®½æ•°å­—ï¼Œä¸­é—´ç”¨ç°è‰²çŸ­ç«–çº¿åˆ†éš”ï¼Œæ•´è¡Œå¹³é“º -->
		<div class="stats-row" aria-label="å…³é”®æ•°å­—">
			<div class="num-block">
				<div class="num-title">æŠ•å…¥èµ„äº§</div>
				<div class="num-value">{{ total_input|default:0|floatformat:2 }}</div>
			</div>
			<div class="sep" aria-hidden="true"></div>
			<div class="num-block">
				<div class="num-title">å‰©ä½™èµ„äº§</div>
				<div class="num-value">{{ total_assets|default:0|floatformat:2 }}</div>
			</div>
		</div>
        <div class="sep-line" aria-hidden="true"></div>

		<!-- è‚¡ç¥¨æŸ¥è¯¢åŒºåŸŸ -->
		<section id="stock-search">
			<h3>æŸ¥è¯¢è‚¡ç¥¨</h3>
			<div class="controls">
				<label>
					<div class="field-title">è‚¡ç¥¨ä»£ç </div>
					<input id="input-code" type="text" placeholder="ä¾‹å¦‚ 000001 æˆ– 600519" />
				</label>
				<label>
					<div class="field-title">è‚¡ç¥¨åç§°</div>
					<input id="input-name" type="text" placeholder="ä¾‹å¦‚ å¹³å®‰é“¶è¡Œ æˆ– è´µå·èŒ…å°" />
				</label>
				<!-- æ–°å¢ï¼šé€‰æ‹©æ—¥æœŸï¼ˆæ—è¾¹æ˜¾ç¤ºè¾“å…¥ + ä¸‹æ–¹æ—¥æœŸé€‰æ‹©å™¨ï¼‰ -->
				<label class="date-label">
					<div class="field-title">é€‰æ‹©æ—¥æœŸï¼ˆè‚¡å¸‚å·¥ä½œæ—¥å¼€æ”¾ï¼‰</div>
					<div class="date-wrapper">
						<input id="selected-date" type="text" placeholder="yyyy/mm/dd" readonly />
						<!-- åŸç”Ÿæ—¥æœŸè¾“å…¥ï¼ˆéšè—ï¼‰ï¼Œç”±æŒ‰é’®è§¦å‘ showPicker/click -->
						<input id="date-picker" type="date" aria-label="é€‰æ‹©æ—¥æœŸ" class="hidden-date" />
					</div>
				</label>
				<button id="btn-clear" class="btn">æ¸…é™¤</button>
			</div>

			<div id="search-note">è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°ï¼Œè‹¥åœ¨æœ¬åœ° CSV ä¸­å­˜åœ¨åŒ¹é…é¡¹ï¼Œå°†è‡ªåŠ¨å¡«å……å¦ä¸€ä¸ªè¾“å…¥æ¡†å¹¶å±•ç¤ºä¿¡æ¯å ä½ã€‚</div>

			<!-- æœªæ”¶å½•æç¤º -->
			<div id="not-found">è¯¥è‚¡ç¥¨å°šæœªæ”¶å½•ï¼Œè¯·æ›´æ¢ä»£ç å°è¯•</div>

			<div id="stock-info">
				<div class="info-row">
					<div class="info-col">
						<div class="field-title">ä»Šæ—¥è‚¡ä»·</div>
						<div id="today-price">â€”</div>
					</div>
					<div class="info-col">
						<div class="field-title">è¾ƒæ˜¨æ—¥å˜åŒ–</div>
						<div id="price-diff">â€”</div>
					</div>
					<div class="info-chart-col">
						<div class="field-title">è¿‘30å¤©èµ°åŠ¿</div>
						<div id="chart-area">
							<canvas id="stockChart" width="400" height="200"></canvas>
						</div>
					</div>
				</div>
				<div id="stock-meta">è‚¡ç¥¨ä¿¡æ¯å ä½ï¼šä»£ç  / åç§° / å…¶ä»–</div>
			</div>
				<!-- è´­å…¥æ§ä»¶ï¼šåœ¨èµ°åŠ¿å›¾ä¸‹æ–¹æ˜¾ç¤º -->
				<div id="buy-controls">
					<div class="buy-left">
						<span style="color:#444;font-size:14px;">è´­å…¥è‚¡æ•°ï¼š</span>
						<input id="buy-count" type="number" min="1" placeholder="è¾“å…¥è‚¡æ•°" />
					</div>
					<div class="buy-actions">
						<button id="btn-buy">è´­å…¥</button>
						<button id="btn-buy-cancel">å–æ¶ˆ</button>
					</div>
				</div>
			</div>
		</section>
	</main>

	<script>
	// å°å‹ CSV è§£æ + å‰ç«¯æŸ¥è¯¢é€»è¾‘
	(function(){
				// ä½¿ç”¨ Django åå‘ URLï¼Œä»¥ä¾¿åœ¨ routes è¢«åŒ…å«åˆ°ä»»æ„å‰ç¼€ä¸‹ä»èƒ½æ­£ç¡®è®¿é—®
				const csvPath = "{% url 'myapp:stock_csv' %}";
				const lookupPath = "{% url 'myapp:stock_lookup' %}";
				const stockInfoPath = "{% url 'myapp:stock_info' %}";

			// å‘åç«¯è¯·æ±‚æŒ‡å®šæ—¥æœŸå’Œä»£ç çš„å•æ—¥è¡Œæƒ…ï¼ˆè°ƒç”¨ StockOperations.get_stock1ï¼‰
			async function fetchStockInfoFromServer(codeKey){
				try{
					// æŸ¥æ‰¾ç´¢å¼•ä¸­çš„å…ƒä¿¡æ¯ä»¥æ„é€ å¸¦ market çš„ä»£ç ï¼ˆä¼˜å…ˆä¸é‡å¤æ·»åŠ åç¼€ï¼‰
					const meta = indexedByCode[codeKey] || indexedByName[codeKey] || null;
					if(!meta) return;
					let codeToSend = meta.code || '';
					// å¦‚æœ code å·²åŒ…å« '.' åˆ™ä¸å†è¿½åŠ  market
					if(codeToSend && !codeToSend.includes('.') && meta.market){
						codeToSend = `${codeToSend}.${meta.market}`;
					}
					// éœ€è¦æ—¥æœŸä¸º YYYYMMDDï¼ˆStockOperations æ¥å—è¯¥æ ¼å¼ï¼‰
					if(!datePickerEl || !datePickerEl.value) return;
					const dateParam = datePickerEl.value.replace(/-/g,'');
					const url = `${stockInfoPath}?date=${encodeURIComponent(dateParam)}&code=${encodeURIComponent(codeToSend)}`;
					const res = await fetch(url);
					if(!res.ok) { throw new Error('network'); }
					const j = await res.json();
					if(j && j.found){
						// å¡«å†™è¿”å›çš„ close å’Œ changeï¼›è‹¥ä¸ºç©ºåˆ™æ˜¾ç¤ºâ€œæš‚æ— ä¿¡æ¯â€
						todayPriceEl.textContent = (j.close !== null && j.close !== undefined) ? j.close : 'æš‚æ— ä¿¡æ¯';
						priceDiffEl.textContent = (j.change !== null && j.change !== undefined) ? j.change : 'æš‚æ— ä¿¡æ¯';
						// é¢œè‰²æ ‡è¯†ï¼ˆæ­£çº¢ã€è´Ÿç»¿ï¼‰
						if(typeof j.change === 'number'){
							priceDiffEl.style.color = j.change>0 ? '#d9534f' : (j.change<0? '#29a673' : '#333');
						}
					} else {
						todayPriceEl.textContent = 'æš‚æ— ä¿¡æ¯';
						priceDiffEl.textContent = 'æš‚æ— ä¿¡æ¯';
					}
				}catch(err){
					console.warn('fetchStockInfoFromServer è¯·æ±‚å¤±è´¥', err);
					// ä¿å®ˆé™çº§ä¸ºæš‚æ— ä¿¡æ¯
					todayPriceEl.textContent = 'æš‚æ— ä¿¡æ¯';
					priceDiffEl.textContent = 'æš‚æ— ä¿¡æ¯';
				}
			}

		// ç®€å• debounce
		function debounce(fn, ms){
			let t = null; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), ms); }
		}

		// è½»é‡ CSV è§£æï¼ˆæ”¯æŒåŒå¼•å·ï¼‰
		function parseCSV(text){
			const rows = [];
			let cur = [];
			let field = '';
			let inQuotes = false;
			for(let i=0;i<text.length;i++){
				const ch = text[i];
				const next = text[i+1];
				if(inQuotes){
					if(ch === '"'){
						if(next === '"'){ field += '"'; i++; } else { inQuotes = false; }
					} else {
						field += ch;
					}
				} else {
					if(ch === '"'){
						inQuotes = true;
					} else if(ch === ','){
						cur.push(field); field = '';
					} else if(ch === '\r'){
						// ignore
					} else if(ch === '\n'){
						cur.push(field); field=''; rows.push(cur); cur=[];
					} else {
						field += ch;
					}
				}
			}
			// æœ€åä¸€è¡Œï¼ˆè‹¥æ— æ¢è¡Œç»“å°¾ï¼‰
			if(field !== '' || cur.length>0){ cur.push(field); rows.push(cur); }
			return rows;
		}

		// å°† CSV è½¬ä¸ºå¯¹è±¡æ•°ç»„ï¼ˆç¬¬ä¸€è¡Œä¸º headerï¼‰
		function csvToObjects(text){
			const rows = parseCSV(text);
			if(rows.length === 0) return [];
			const headers = rows[0].map(h=>String(h||'').trim());
			const data = [];
			for(let i=1;i<rows.length;i++){
				const r = rows[i];
				if(r.length === 1 && r[0].trim() === '') continue; // skip blank
				const obj = {};
				for(let j=0;j<headers.length;j++){
					obj[headers[j] || j] = (r[j] !== undefined ? r[j] : '').trim();
				}
				data.push(obj);
			}
			return {headers, data};
		}

		// å°è¯•ä» headers ä¸­åŒ¹é…æŸåˆ—åï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œä½¿ç”¨å€™é€‰è¯
		function findHeader(headers, candidates){
			const low = headers.map(h=>String(h||'').toLowerCase());
			for(const c of candidates){
				const idx = low.findIndex(h=>h === c.toLowerCase());
				if(idx !== -1) return headers[idx];
			}
			// æ¬¡ä¼˜ï¼šåŒ…å«å…³é”®è¯
			for(const c of candidates){
				const idx = low.findIndex(h=>h.includes(c.toLowerCase()));
				if(idx !== -1) return headers[idx];
			}
			return null;
		}

		// UI refs
		const inputCode = document.getElementById('input-code');
		const inputName = document.getElementById('input-name');
		const infoBox = document.getElementById('stock-info');
		const notFoundEl = document.getElementById('not-found');
		const buyControlsEl = document.getElementById('buy-controls');
		const todayPriceEl = document.getElementById('today-price');
		const priceDiffEl = document.getElementById('price-diff');
		const chartArea = document.getElementById('chart-area');
		const stockMeta = document.getElementById('stock-meta');
		const btnClear = document.getElementById('btn-clear');
		// æ–°å¢ï¼šæ—¥æœŸæ˜¾ç¤ºä¸é€‰æ‹©å™¨
		const selectedDateEl = document.getElementById('selected-date');
		const datePickerEl = document.getElementById('date-picker');
		const dateBtn = document.getElementById('date-btn');

		// è¾…åŠ©ï¼šåˆ¤æ–­ä¸‰ä¸ªè¾“å…¥æ¡†æ˜¯å¦ä¸ºâ€œéƒ¨åˆ†å¡«å†™â€çŠ¶æ€ï¼ˆå³ 0 < å¡«å†™æ•° < 3ï¼‰
		function isPartiallyFilled(){
			const hasCode = inputCode && inputCode.value.trim() !== '';
			const hasName = inputName && inputName.value.trim() !== '';
			const hasDate = datePickerEl && !!datePickerEl.value;
			const count = (hasCode?1:0) + (hasName?1:0) + (hasDate?1:0);
			return count > 0 && count < 3;
		}

		let indexedByCode = {};
		let indexedByName = {};
		let groupedByCode = {};

		async function loadAndIndex(){
			try{
				const res = await fetch(csvPath);
				if(!res.ok) throw new Error('æ— æ³•åŠ è½½ CSV: ' + res.status);
				const text = await res.text();
				const {headers, data} = csvToObjects(text);

				// å€™é€‰åˆ—å
				const codeCandidates = ['ä»£ç ','ts_code','stock_code','code','symbol','ticker'];
				const nameCandidates = ['åç§°','name','stock_name','fullname','ç®€ç§°'];
				const dateCandidates = ['date','æ—¥æœŸ','trade_date'];
				const closeCandidates = ['close','æ”¶ç›˜','close_price','price','adj_close'];

				const codeCol = findHeader(headers, codeCandidates) || headers[0];
				const nameCol = findHeader(headers, nameCandidates) || headers[1] || null;
				const dateCol = findHeader(headers, dateCandidates) || null;
				const closeCol = findHeader(headers, closeCandidates) || null;
				// é¢å¤–è¯†åˆ« market åˆ—ï¼ˆäº¤æ˜“æ‰€åç¼€ï¼‰
				const marketCandidates = ['market','äº¤æ˜“æ‰€','exch','exchange'];
				const marketCol = findHeader(headers, marketCandidates) || null;

				indexedByCode = {};
				indexedByName = {};
				groupedByCode = {};

				data.forEach(row=>{
					const code = String(row[codeCol] || '').trim();
					const name = nameCol ? String(row[nameCol] || '').trim() : '';
					const market = marketCol ? String(row[marketCol] || '').trim() : '';
					if(!code && !name) return;
					const keyCode = code.toLowerCase();
					const keyName = name.toLowerCase();

					// store first-seen as metadata if not present
					if(code){
						if(!indexedByCode[keyCode]) indexedByCode[keyCode] = {code, name, market: market || '', rows: []};
						// å¦‚æœåç»­è¡ŒåŒ…å«æ›´å®Œæ•´çš„ä¿¡æ¯ï¼ˆå¦‚ marketï¼‰ï¼Œä¼˜å…ˆä¿ç•™éç©º market
						if(market && !indexedByCode[keyCode].market) indexedByCode[keyCode].market = market;
						indexedByCode[keyCode].rows.push(row);
					}
					if(name){
						if(!indexedByName[keyName]) indexedByName[keyName] = {code, name, market: market || '', rows: []};
						if(market && !indexedByName[keyName].market) indexedByName[keyName].market = market;
						indexedByName[keyName].rows.push(row);
					}
					// group by code
					if(code){
						if(!groupedByCode[keyCode]) groupedByCode[keyCode] = [];
						groupedByCode[keyCode].push(row);
					}
				});

				// å¦‚æœ grouped æœ‰æ—¥æœŸå­—æ®µï¼ŒæŒ‰æ—¥æœŸé™åºæ’åˆ—ï¼ˆå°è¯•è¯†åˆ« yyyy-mm-dd æˆ– yyyymmddï¼‰
				if(dateCol){
					Object.keys(groupedByCode).forEach(k=>{
						groupedByCode[k].sort((a,b)=>{
							const da = String(a[dateCol]||'');
							const db = String(b[dateCol]||'');
							return (db.localeCompare(da));
						});
					});
				}

				// expose columns for later usage
				loadAndIndex._cols = {codeCol,nameCol,dateCol,closeCol,headers};

			}catch(err){
				console.error('åŠ è½½ CSV å¤±è´¥', err);
			}
		}

		function showStockByCode(rawCode){
			if(!rawCode) return;
			const k = String(rawCode).trim().toLowerCase();
			const meta = indexedByCode[k];
			if(meta){
				// å¡«å…… name
				if(meta.name) inputName.value = meta.name;
				// ä»…åœ¨ç”¨æˆ·å·²é€‰æ‹©æ—¥æœŸæ—¶å±•ç¤ºè¯¦ç»†ä¿¡æ¯
				if(datePickerEl && datePickerEl.value){
					notFoundEl.style.display = 'none';
					showInfoForCode(k);
				} else {
					// åªæœ‰å½“ä¸‰ä¸ªè¾“å…¥æ¡†å¤„äºéƒ¨åˆ†å¡«å†™ï¼ˆæœ‰å†…å®¹ä½†ä¸å…¨ï¼‰æ—¶ï¼Œæ‰æç¤ºâ€œè¯·å…ˆé€‰æ‹©æ—¥æœŸâ€
					if(isPartiallyFilled()){
						notFoundEl.textContent = 'è¯·å…ˆé€‰æ‹©æ—¥æœŸä»¥æŸ¥çœ‹è¯¦ç»†å†…å®¹';
						notFoundEl.style.display = 'block';
					} else {
						notFoundEl.style.display = 'none';
					}
					infoBox.style.display = 'none';
					if(buyControlsEl) buyControlsEl.style.display = 'none';
				}
				return true;
			}
			return false;
		}

		function showStockByName(rawName){
			if(!rawName) return;
			const k = String(rawName).trim().toLowerCase();
			let meta = indexedByName[k];
			if(!meta){
				// å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆåŒ…å«ï¼‰
				const keys = Object.keys(indexedByName).find(n=>n.includes(k));
				if(keys) meta = indexedByName[keys];
			}
			if(meta){
				if(meta.code) inputCode.value = meta.code;
				// ä»…åœ¨ç”¨æˆ·å·²é€‰æ‹©æ—¥æœŸæ—¶å±•ç¤ºè¯¦ç»†ä¿¡æ¯
				const codeKey = String(meta.code||'').toLowerCase();
				if(datePickerEl && datePickerEl.value){
					notFoundEl.style.display = 'none';
					showInfoForCode(codeKey);
				} else {
					// åªæœ‰å½“ä¸‰ä¸ªè¾“å…¥æ¡†å¤„äºéƒ¨åˆ†å¡«å†™ï¼ˆæœ‰å†…å®¹ä½†ä¸å…¨ï¼‰æ—¶ï¼Œæ‰æç¤ºâ€œè¯·å…ˆé€‰æ‹©æ—¥æœŸâ€
					if(isPartiallyFilled()){
						notFoundEl.textContent = 'è¯·å…ˆé€‰æ‹©æ—¥æœŸä»¥æŸ¥çœ‹è¯¦ç»†å†…å®¹';
						notFoundEl.style.display = 'block';
					} else {
						notFoundEl.style.display = 'none';
					}
					infoBox.style.display = 'none';
					if(buyControlsEl) buyControlsEl.style.display = 'none';
				}
				
				return true;
			}
			return false;
		}
		async function draw30DayChart(codeKey, stockMap, datePicker, stockInfoPath) {
			console.log('ğŸ¨ å‡†å¤‡ç”» 30 æ—¥å›¾', codeKey);
			const meta = stockMap[codeKey] || {};

			let chartCanvas = document.getElementById('stockChart');
			const chartArea = document.getElementById('chart-area');

			if (!chartArea) {
				console.error('å›¾è¡¨å®¹å™¨ä¸å­˜åœ¨');
				return;
			}

			if (!chartCanvas) {
				chartArea.innerHTML = '<canvas id="stockChart" width="400" height="200"></canvas>';
				chartCanvas = document.getElementById('stockChart');
			}

			if (window.myStockChart) {
				window.myStockChart.destroy();
				window.myStockChart = null;
			}

			let codeToSend = meta.code || '';
			if (codeToSend && !codeToSend.includes('.') && meta.market) {
				codeToSend = `${codeToSend}.${meta.market}`;
			}

			if (!datePicker || !datePicker.value) {
				console.error('æœªé€‰æ‹©æ—¥æœŸ');
				chartArea.innerHTML = '<small class="text-muted">è¯·å…ˆé€‰æ‹©æ—¥æœŸ</small>';
				return;
			}

			const dateParam = datePicker.value.replace(/-/g, '');
			const url30 = `${stockInfoPath}?date=${dateParam}&code=${encodeURIComponent(codeToSend)}`;

			console.log('ğŸ“¡ è¯·æ±‚ 30 æ—¥æ•°æ®:', url30);

			try {
				const res30 = await fetch(url30);
				const j30 = await res30.json();
				console.log('ğŸ“Š 30 æ—¥æ•°æ®å“åº”:', j30);

				if (j30.found && j30.dates && j30.closes && j30.dates.length > 0) {
					const labels = j30.dates.map(d => {
						if (d.length === 8) {
							return `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)}`;
						}
						return d;
					});

					const ctx = chartCanvas.getContext('2d');
					window.myStockChart = new Chart(ctx, {
						type: 'line',
						data: {
							labels: labels,
							datasets: [{
								label: 'æ”¶ç›˜ä»·',
								data: j30.closes,
								borderColor: '#2f6fe8',
								backgroundColor: 'rgba(47, 111, 232, 0.15)',
								borderWidth: 2,
								tension: 0.3,
								pointRadius: 3,
								pointHoverRadius: 6,
								pointBackgroundColor: '#2f6fe8',
								fill: true
							}]
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							plugins: {
								legend: {
									display: false
								},
								tooltip: {
									mode: 'index',
									intersect: false
								}
							},
							scales: {
								x: {
									grid: {
										display: false
									},
									ticks: {
										maxTicksLimit: 8,
										font: {
											size: 11
										},
										color: '#666'
									}
								},
								y: {
									grid: {
										color: 'rgba(0,0,0,0.06)',
										drawBorder: false
									},
									ticks: {
										font: {
											size: 11
										},
										color: '#666',
										callback: function (value) {
											return 'Â¥' + value.toFixed(2);
										}
									},
									beginAtZero: false
								}
							}
						}
					});
				} else {
					console.warn('æ²¡æœ‰æœ‰æ•ˆçš„ 30 æ—¥æ•°æ®:', j30);
					chartArea.innerHTML = '<small class="text-muted">æš‚æ—  30 æ—¥èµ°åŠ¿æ•°æ®</small>';
				}
			} catch (error) {
				console.error('è·å– 30 æ—¥æ•°æ®å¤±è´¥:', error);
				chartArea.innerHTML = '<small class="text-muted">æ•°æ®åŠ è½½å¤±è´¥</small>';
			}
		}
		function showInfoForCode(codeKey) {
			const stockMap = indexedByCode;
			const cols = loadAndIndex._cols || {};
			const group = groupedByCode[codeKey] || [];
			infoBox.style.display = 'block';
			if (buyControlsEl) buyControlsEl.style.display = 'flex';
			if (indexedByCode[codeKey]) {
				const meta = indexedByCode[codeKey];
				const marketPart = meta.market ? `.${meta.market}` : '';
				stockMeta.textContent = `${meta.code}${marketPart}/${meta.name || 'â€”'}`;
			} else {
				stockMeta.textContent = 'â€”';
			}

			// å°è¯•è®¡ç®—ä»Šæ—¥ä¸æ˜¨æ—¥ä»·æ ¼
			if (cols.dateCol && cols.closeCol && group.length > 0) {
				const latest = group[0];
				const prev = group[1];
				const latestPrice = parseFloat(String(latest[cols.closeCol] || '').replace(/,/g, ''));
				const prevPrice = prev ? parseFloat(String(prev[cols.closeCol] || '').replace(/,/g, '')) : NaN;
				if (!isNaN(latestPrice)) {
					todayPriceEl.textContent = latestPrice;
				} else { todayPriceEl.textContent = 'â€”'; }
				if (!isNaN(prevPrice)) {
					const diff = latestPrice - prevPrice;
					const pct = (diff / prevPrice * 100).toFixed(2);
					const sign = diff > 0 ? '+' : (diff < 0 ? '' : '');
					priceDiffEl.textContent = `${sign}${diff.toFixed(2)} (${pct}%)`;
					priceDiffEl.style.color = diff > 0 ? '#d9534f' : (diff < 0 ? '#29a673' : '#333');
				} else {
					priceDiffEl.textContent = 'â€”';
					priceDiffEl.style.color = '#333';
				}
			} else {
				todayPriceEl.textContent = 'â€”';
				priceDiffEl.textContent = 'â€”';
				priceDiffEl.style.color = '#333';
			}

			if (codeKey) {
				draw30DayChart(codeKey, indexedByCode, datePickerEl, stockInfoPath);
				// ä»…å½“ä¸‰ä¸ªè¾“å…¥æ¡†ï¼ˆä»£ç ã€åç§°ã€æ—¥æœŸï¼‰éƒ½æœ‰å€¼æ—¶ï¼Œæ‰è°ƒç”¨åç«¯è·å–å®æ—¶ï¼ˆå•æ—¥ï¼‰æ•°æ®
				if (typeof fetchStockInfoFromServer === 'function' && inputCode.value.trim() && inputName.value.trim() && datePickerEl && datePickerEl.value) {
					try {
						fetchStockInfoFromServer(codeKey);
					} catch (err) {
						console.warn('fetchStockInfoFromServer è°ƒç”¨å¤±è´¥ï¼š', err);
					}
				}
			}
		}

		// ç»‘å®šäº‹ä»¶ï¼ˆè¾“å…¥æ—¶å°è¯•åŒ¹é…å¹¶äº’ç›¸å¡«å……ï¼‰
		const tryMatchCode = debounce(function(){
			const v = inputCode.value.trim();
			if(!v){
				// è‹¥ä»£ç ä¸ºç©ºï¼šéšè—æç¤ºä¸ä¿¡æ¯ï¼Œå¹¶åŒæ—¶æ¸…ç©ºåç§°è¾“å…¥ï¼Œä¿è¯ä¸¤è€…åŒæ­¥æ¸…ç©º
				notFoundEl.style.display = 'none';
				infoBox.style.display = 'none';
				if(buyControlsEl) buyControlsEl.style.display = 'none';
				// åŒæ­¥æ¸…ç©ºåç§°ï¼Œæ»¡è¶³â€œäºŒè€…æ— è®ºè°è¢«æ¸…ç©ºäº†ï¼Œå¦ä¸€ä¸ªä¹Ÿè¦è·Ÿç€æ¸…ç©ºâ€çš„éœ€æ±‚
				if(inputName) inputName.value = '';
				return;
			}
			const found = showStockByCode(v);
			if(found){
				notFoundEl.style.display = 'none';
				return;
			}
			// å¦‚æœæœ¬åœ°æœªå‘½ä¸­ï¼Œå°è¯•è¯·æ±‚åç«¯ API
				fetch(`${lookupPath}?code=${encodeURIComponent(v)}`)
				.then(r=>r.json())
				.then(j=>{
					if(j && j.found){
						if(j.name) inputName.value = j.name;
						notFoundEl.style.display = 'none';
						// è‹¥å·²é€‰æ—¥æœŸï¼Œå±•ç¤ºè¯¦æƒ…
						if(datePickerEl && datePickerEl.value){
							showInfoForCode(String(j.code||'').toLowerCase());
						}
					} else {
						// æœªæ‰¾åˆ°åˆ™æç¤ºå¹¶æ¸…ç©ºåç§°è¾“å…¥
						notFoundEl.textContent = 'è¯¥è‚¡ç¥¨å°šæœªæ”¶å½•ï¼Œè¯·æ›´æ¢ä»£ç å°è¯•';
						notFoundEl.style.display = 'block';
						infoBox.style.display = 'none';
						if(buyControlsEl) buyControlsEl.style.display = 'none';
						inputName.value = '';
					}
				})
				.catch(err=>{
					console.warn('stock-lookup è¯·æ±‚å¤±è´¥', err);
				});
		}, 240);

		const tryMatchName = debounce(function(){
			const v = inputName.value.trim();
			if(!v){
				// è‹¥åç§°ä¸ºç©ºï¼Œéšè—æç¤ºä¸ä¿¡æ¯ï¼Œå¹¶æ¸…ç©ºä»£ç è¾“å…¥
				notFoundEl.style.display = 'none';
				infoBox.style.display = 'none';
				// æŒ‰ç”¨æˆ·è¦æ±‚ï¼šæ¸…ç©ºä»£ç è¾“å…¥
				inputCode.value = '';
				if(buyControlsEl) buyControlsEl.style.display = 'none';
				return;
			}
			const found = showStockByName(v);
			if(found){
				notFoundEl.style.display = 'none';
				return;
			}
			// æœ¬åœ°æœªå‘½ä¸­ï¼Œå°è¯•åç«¯æ¨¡ç³Š/ç²¾ç¡®æŸ¥è¯¢
				fetch(`${lookupPath}?name=${encodeURIComponent(v)}`)
				.then(r=>r.json())
				.then(j=>{
					if(j && j.found){
						if(j.code) inputCode.value = j.code;
						notFoundEl.style.display = 'none';
						// è‹¥å·²é€‰æ—¥æœŸï¼Œå±•ç¤ºè¯¦æƒ…
						if(datePickerEl && datePickerEl.value){
							showInfoForCode(String(j.code||'').toLowerCase());
						}
					} else {
						// æœªæ‰¾åˆ°åˆ™æç¤ºå¹¶æ¸…ç©ºä»£ç è¾“å…¥
						notFoundEl.textContent = 'è¯¥è‚¡ç¥¨å°šæœªæ”¶å½•ï¼Œè¯·æ›´æ¢åç§°å°è¯•';
						notFoundEl.style.display = 'block';
						infoBox.style.display = 'none';
						if(buyControlsEl) buyControlsEl.style.display = 'none';
						inputCode.value = '';
					}
				})
				.catch(err=>{
					console.warn('stock-lookup è¯·æ±‚å¤±è´¥', err);
				});
		}, 240);

		inputCode.addEventListener('input', tryMatchCode);
		inputName.addEventListener('input', tryMatchName);

		btnClear.addEventListener('click', function(){
			inputCode.value = '';
			inputName.value = '';
			infoBox.style.display = 'none';
			notFoundEl.style.display = 'none';
			if(buyControlsEl) buyControlsEl.style.display = 'none';
			// æ¸…é™¤é€‰æ‹©çš„æ—¥æœŸ
			if(selectedDateEl) selectedDateEl.value = '';
			if(datePickerEl) datePickerEl.value = '';
		});

		// è®¾ç½®æ—¥æœŸæ§ä»¶æœ€å¤§å¯é€‰ä¸ºä»Šå¤©ï¼Œå¹¶ç»‘å®šäº¤äº’
		(function setupDatePicker(){
			if(!datePickerEl) return;
			const d = new Date();
			const y = d.getFullYear();
			const m = String(d.getMonth()+1).padStart(2,'0');
			const day = String(d.getDate()).padStart(2,'0');
			const iso = `${y}-${m}-${day}`;
			datePickerEl.max = iso;
			// æ ¼å¼åŒ–ä¸º yyyy/mm/dd
			function fmt(isoDate){
				if(!isoDate) return '';
				const dt = new Date(isoDate);
				if(isNaN(dt)) return isoDate;
				const Y = dt.getFullYear();
				const M = String(dt.getMonth()+1).padStart(2,'0');
				const D = String(dt.getDate()).padStart(2,'0');
				return `${Y}/${M}/${D}`;
			}
			// å½“é€‰æ‹©æ—¥æœŸæ—¶ï¼Œå¡«å……åªè¯»æ˜¾ç¤ºè¾“å…¥ï¼ˆæ ¼å¼ yyyy/mm/ddï¼‰
			datePickerEl.addEventListener('change', function(){
				// éªŒè¯ï¼šä¸èƒ½é€‰æ‹©å‘¨æœ«
				if(this.value){
					const sel = new Date(this.value);
					const wd = sel.getDay(); // 0 = Sunday, 6 = Saturday
					if(wd === 0 || wd === 6){
						// æç¤ºå¹¶æ¸…ç©º
						notFoundEl.textContent = 'æ‰€é€‰æ—¥æœŸä¸ºå‘¨æœ«ï¼Œè¯·é€‰æ‹©å·¥ä½œæ—¥';
						notFoundEl.style.display = 'block';
						this.value = '';
						if(selectedDateEl) selectedDateEl.value = '';
						// éšè—è¯¦æƒ…
						infoBox.style.display = 'none';
						if(buyControlsEl) buyControlsEl.style.display = 'none';
						return;
					}
				}
				// æ ¼å¼åŒ–æ˜¾ç¤º
				if(selectedDateEl) selectedDateEl.value = this.value ? fmt(this.value) : '';
				// å¦‚æœç”¨æˆ·å·²è¾“å…¥ä»£ç æˆ–åç§°ï¼Œé€‰æ‹©æ—¥æœŸåè‡ªåŠ¨å°è¯•å±•ç¤ºè¯¦ç»†ä¿¡æ¯
				const codeVal = inputCode.value.trim();
				const nameVal = inputName.value.trim();
				if(this.value){
					if(codeVal){
						// è‹¥å­˜åœ¨æœ‰æ•ˆä»£ç å¹¶åœ¨ç´¢å¼•ä¸­ï¼Œç›´æ¥å±•ç¤º
						const k = String(codeVal).toLowerCase();
						if(indexedByCode[k]){
							notFoundEl.style.display = 'none';
							showInfoForCode(k);
							return;
						}
					}
					if(nameVal){
						const nk = String(nameVal).toLowerCase();
						let meta = indexedByName[nk];
						if(!meta){
							const keys = Object.keys(indexedByName).find(n=>n.includes(nk));
							if(keys) meta = indexedByName[keys];
						}
						if(meta && meta.code){
							const codeKey = String(meta.code).toLowerCase();
							notFoundEl.style.display = 'none';
							showInfoForCode(codeKey);
							return;
						}
					}
					// å¦‚æœåˆ°è¿™é‡Œä»æ— æ³•å±•ç¤ºï¼Œä¿æŒæç¤ºï¼ˆè‹¥ä¹‹å‰æ˜¯å› æœªé€‰æ‹©æ—¥æœŸè€Œæ˜¾ç¤ºæç¤ºï¼Œåˆ™ä¿ç•™ï¼‰
				}
			});
			// ç‚¹å‡»æ˜¾ç¤ºè¾“å…¥æˆ–æŒ‰é’®æ—¶æ‰“å¼€åŸç”Ÿæ—¥æœŸé€‰æ‹©å™¨
			function openPicker(){
				try{
					if(typeof datePickerEl.showPicker === 'function') datePickerEl.showPicker();
					else { datePickerEl.click(); datePickerEl.focus(); }
				}catch(e){ try{ datePickerEl.click(); datePickerEl.focus(); }catch(_){ /* ignore */ } }
			}
			if(selectedDateEl) selectedDateEl.addEventListener('click', openPicker);
			if(dateBtn) dateBtn.addEventListener('click', openPicker);
		})();

		// åˆå§‹åŠ è½½
		loadAndIndex().then(()=>{
			// å·²åŠ è½½ï¼Œå¯é€‰ï¼šè‹¥è¾“å…¥æ¡†å·²æœ‰å†…å®¹ï¼Œè§¦å‘ä¸€æ¬¡åŒ¹é…
			if(inputCode.value.trim()) tryMatchCode();
			if(inputName.value.trim()) tryMatchName();
		});

		// è´­å…¥æ§ä»¶è¡Œä¸ºï¼šç®€å•æ¨¡æ‹Ÿ
		const buyCountEl = document.getElementById('buy-count');
		const btnBuy = document.getElementById('btn-buy');
		const btnBuyCancel = document.getElementById('btn-buy-cancel');

		// helper: format number to localized currency-like string (max 2 decimals)
		function fmtNumber(n){
			if(n === null || n === undefined) return '-';
			const num = Number(n);
			if(isNaN(num)) return '-';
			return num.toLocaleString('zh-CN', {minimumFractionDigits:2, maximumFractionDigits:2});
		}

		btnBuy.addEventListener('click', async function(){
			const v = parseInt(buyCountEl.value, 10);
			if(!v || v <= 0){
				alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è´­å…¥è‚¡æ•°ï¼ˆå¤§äº 0ï¼‰');
				return;
			}
			// æ„é€ è¯·æ±‚å‚æ•°ï¼šcode, date (YYYY-MM-DD), piles
			const code = inputCode.value.trim();
			const dateIso = datePickerEl && datePickerEl.value ? datePickerEl.value : '';
			if(!code){ alert('è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©ä¸€ä¸ªè‚¡ç¥¨ä»£ç '); return; }
			if(!dateIso){ alert('è¯·å…ˆé€‰æ‹©äº¤æ˜“æ—¥æœŸ'); return; }
			const buyUrl = "{% url 'myapp:buy_stock' %}";
			try{
				const payload = { code: code, date: dateIso, piles: v };
				const resp = await fetch(buyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
				const j = await resp.json();
				if(!resp.ok){ alert('è¯·æ±‚å¤±è´¥'); return; }
				if(j.success){
					alert('è´­ä¹°æˆåŠŸï¼š' + (j.details && j.details.cost ? ('å…±æ”¯ä»˜ ' + fmtNumber(j.details.cost)) : ''));
					// æ¸…ç©ºè¾“å…¥
					buyCountEl.value = '';
					// è‹¥è¿”å› remaining_funds æˆ– total_inputï¼Œåˆ™å°è¯•æ›´æ–°é¡µé¢æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
					try{
						if(j.details){
							// é¡µé¢ä¸Šæ•°å€¼ä½ç½®åœ¨æ¨¡æ¿æ¸²æŸ“ä¸­ï¼Œå¯»æ‰¾ .num-block ä¸­çš„ä¸¤ä¸ªå€¼ï¼š0=æŠ•å…¥èµ„äº§, 1=å‰©ä½™èµ„äº§
							const assetsEls = document.querySelectorAll('.num-block .num-value');
							if(assetsEls && assetsEls.length>=2){
								if(j.details.total_input !== undefined){
									assetsEls[0].textContent = fmtNumber(j.details.total_input);
								}
								if(j.details.remaining_funds !== undefined){
									assetsEls[1].textContent = fmtNumber(j.details.remaining_funds);
								}
							}
						}
					}catch(_){ }
				}else{
					alert('è´­ä¹°å¤±è´¥ï¼š' + (j.message || j.error || 'æœªçŸ¥é”™è¯¯'));
				}
			}catch(err){
				console.warn('buy request failed', err);
				alert('è´­ä¹°è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
			}
		});

		btnBuyCancel.addEventListener('click', function(){
			buyCountEl.value = '';
		});

	})();
	</script>
	</body>
</html>

